blueprint:
  name: "AWTRIX Protezione Civile Alert ðŸ‡®ðŸ‡¹"
  description:
    "Mostra gli alert meteo della Protezione Civile sul tuo dispositivo AWTRIX.\n\n
    ## âš ï¸ REQUISITI âš ï¸\n
    Devi avere installato l'integrazione [DPC Alert](https://github.com/caiosweet/Home-Assistant-custom-components-DPC-Alert).\n\n
    ## ðŸ“¦ ICONE CONSIGLIATE\n
    Ti consiglio di caricare queste icone sul tuo AWTRIX:\n
    - `dpc-idraulico` - Rischio idraulico (alluvioni)\n
    - `dpc-temporali` - Rischio temporali\n
    - `dpc-idrogeologico` - Rischio idrogeologico (frane)\n
    - `dpc-warning` - Icona generica alert\n\n
    Puoi usare icone da [https://developer.lametric.com/icons](https://developer.lametric.com/icons) o crearne di personalizzate.\n\n
    Aggiornamenti: https://github.com/Raythekool/awtrix_dpc_alert/blob/main/awtrix_dpc_alert.yaml"
  domain: automation
  input:
    awtrix:
      name: Dispositivo AWTRIX
      description: Seleziona il tuo dispositivo AWTRIX
      selector:
        device:
          integration: mqtt
          manufacturer: Blueforcer
          model: AWTRIX 3
          multiple: true

    dpc_sensors:
      name: Sensori DPC Alert
      description: Seleziona i sensori di allerta che vuoi monitorare
      selector:
        entity:
          filter:
            - domain: binary_sensor
              integration: dpc
          multiple: true

    warning_level:
      name: Livello minimo di allerta
      description: |
        0 = Mostra tutte le allerte (anche assenza criticitÃ )
        1 = Verde (Ordinaria criticitÃ )
        2 = Giallo (Moderata criticitÃ )
        3 = Arancione (CriticitÃ  elevata)
        4 = Rosso (CriticitÃ  estrema)
      selector:
        number:
          min: 0
          max: 4
          mode: box
          step: 1
      default: 1

    message_duration:
      name: Durata messaggio â±ï¸
      description: Quanto tempo deve rimanere il messaggio sullo schermo (in secondi). 0 = usa il tempo globale
      selector:
        number:
          min: 0
          max: 300
          unit_of_measurement: sec
          step: 1
          mode: slider
      default: 20

    icon_idraulico:
      name: Icona Rischio Idraulico
      description: "Icona per il rischio idraulico (alluvioni, esondazioni).\n
        Nome file: dpc-idraulico"
      selector:
        text: {}
      default: "dpc-idraulico"

    icon_temporali:
      name: Icona Rischio Temporali
      description: "Icona per il rischio temporali.\n
        Nome file: dpc-temporali"
      selector:
        text: {}
      default: "dpc-temporali"

    icon_idrogeologico:
      name: Icona Rischio Idrogeologico
      description: "Icona per il rischio idrogeologico (frane, smottamenti).\n
        Nome file: dpc-idrogeologico"
      selector:
        text: {}
      default: "dpc-idrogeologico"

    icon_warning:
      name: Icona Alert Generica
      description: "Icona generica per altri tipi di alert.\n
        Nome file: dpc-warning"
      selector:
        text: {}
      default: "dpc-warning"

    enable_sound:
      name: Abilita Suono ðŸ”Š
      description: Riproduce un suono quando arriva un'allerta
      selector:
        boolean: {}
      default: false

    sound_level:
      name: Livello minimo per suono
      description: |
        Riproduci suono solo per allerte di questo livello o superiore:
        1 = Verde (Ordinaria)
        2 = Giallo (Moderata)
        3 = Arancione (Elevata)
        4 = Rosso (Estrema)
      selector:
        number:
          min: 1
          max: 4
          mode: box
          step: 1
      default: 3

    sound_file:
      name: File Suono
      description: |
        Nome del file audio da riprodurre (senza estensione).
        Esempi: alarm, doorbell, notification, etc.
        Vedi la documentazione AWTRIX per i suoni disponibili.
      selector:
        text: {}
      default: "alarm"

    display_mode:
      name: Display Mode ðŸ“º
      description: |
        Choose how to display alerts on AWTRIX:
        - Custom App: Persistent display until cleared
        - Notification: Temporary pop-up that auto-dismisses
        - Both: Send both custom app and notification
      selector:
        select:
          options:
            - label: "Custom App (Persistent)"
              value: "app"
            - label: "Notification (Temporary)"
              value: "notification"
            - label: "Both"
              value: "both"
      default: "app"

mode: restart

variables:
  device_ids: !input awtrix
  app_topic: "dpc_alert"
  devices_topics: |
    {%- macro get_device_topic(device_id) %}
      {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro %}
    {%- set ns = namespace(devices=[]) %}
    {%- for device_id in device_ids %}
      {%- set device=get_device_topic(device_id)|replace('','') %}
      {% set ns.devices = ns.devices + [ device ~ '/custom/' ~ app_topic] %}
    {%- endfor %}
    {{ ns.devices | reject('match','unavailable') | list }}

  notify_topics: |
    {%- macro get_device_topic(device_id) %}
      {{ states((device_entities(device_id) | select('search','device_topic') | list)[0]) }}
    {%- endmacro %}
    {%- set ns = namespace(devices=[]) %}
    {%- for device_id in device_ids %}
      {%- set device=get_device_topic(device_id)|replace('','') %}
      {% set ns.devices = ns.devices + [ device ~ '/notify'] %}
    {%- endfor %}
    {{ ns.devices | reject('match','unavailable') | list }}

  dpc_sensors: !input dpc_sensors
  warning_level: !input warning_level
  message_duration: !input message_duration
  icon_idraulico: !input icon_idraulico
  icon_temporali: !input icon_temporali
  icon_idrogeologico: !input icon_idrogeologico
  icon_warning: !input icon_warning
  enable_sound: !input enable_sound
  sound_level: !input sound_level
  sound_file: !input sound_file
  display_mode: !input display_mode

  # Color map for criticality levels
  color_map:
    0: "#0080FF"
    1: "#00FF00"
    2: "#FFFF00"
    3: "#FF6000"
    4: "#FF0000"

  # Criticality level names
  level_names:
    0: "Nessuna"
    1: "Ordinaria"
    2: "Moderata"
    3: "Elevata"
    4: "Estrema"

  # Build payload with all active alerts
  alerts: |
    {%- set ns = namespace(alerts=[]) %}
    {%- for sensor in dpc_sensors %}
      {%- if is_state(sensor, 'on') and state_attr(sensor, 'level')|int(0) >= warning_level %}
        {%- set level = state_attr(sensor, 'level')|int(0) %}
        {%- set alert = state_attr(sensor, 'alert') %}
        {%- set risk = state_attr(sensor, 'risk') %}
        {%- set zone = state_attr(sensor, 'zone_name') %}
        {%- set expires = state_attr(sensor, 'expires') %}
        
        {%- set icon = icon_warning %}
        {%- if 'idraulico' in risk|lower %}
          {%- set icon = icon_idraulico %}
        {%- elif 'temporali' in risk|lower %}
          {%- set icon = icon_temporali %}
        {%- elif 'idrogeologico' in risk|lower %}
          {%- set icon = icon_idrogeologico %}
        {%- endif %}
        
        {%- set alert_obj = {
          'icon': icon,
          'text': alert ~ ' - ' ~ zone,
          'duration': message_duration,
          'color': color_map[level],
          'pushIcon': 2,
          'repeat': 1,
          'effect': 'ripple'
        } %}
        {%- if enable_sound and level >= sound_level %}
          {%- set _ = alert_obj.update({'sound': sound_file}) %}
        {%- endif %}
        {%- if display_mode in ['notification', 'both'] %}
          {%- set _ = alert_obj.update({'hold': true}) %}
        {%- endif %}
        {%- set ns.alerts = ns.alerts + [alert_obj] %}
      {%- endif %}
    {%- endfor %}
    {{ ns.alerts }}

  payload: |
    {%- set alert_list = alerts %}
    {%- if alert_list|length > 0 %}
      {%- if alert_list|length == 1 %}
        {{ alert_list[0]|tojson }}
      {%- else %}
        {{ alert_list|tojson }}
      {%- endif %}
    {%- else %}
      {}
    {%- endif %}

trigger:
  - platform: state
    entity_id: !input dpc_sensors
    id: alert_change

condition: []

action:
  # Send to custom app if mode is 'app' or 'both'
  - if:
      - condition: template
        value_template: "{{ display_mode in ['app', 'both'] }}"
    then:
      - repeat:
          for_each: "{{ devices_topics }}"
          sequence:
            # Remove previous app
            - service: mqtt.publish
              data:
                qos: 0
                retain: false
                topic: "{{ repeat.item }}"
                payload: ""

            # Publish new alerts (if present)
            - if:
                - condition: template
                  value_template: "{{ alerts|length > 0 }}"
              then:
                - service: mqtt.publish
                  data:
                    qos: 0
                    retain: false
                    topic: "{{ repeat.item }}"
                    payload: "{{ payload }}"

  # Send AWTRIX notification if mode is 'notification' or 'both'
  - if:
      - condition: template
        value_template: "{{ display_mode in ['notification', 'both'] and alerts|length > 0 }}"
    then:
      - repeat:
          for_each: "{{ notify_topics }}"
          sequence:
            - service: mqtt.publish
              data:
                qos: 0
                retain: false
                topic: "{{ repeat.item }}"
                payload: "{{ payload }}"
